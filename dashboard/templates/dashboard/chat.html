{% extends 'dashboard/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}

<!-- Font Awesome for Delete Icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    body {
        background-color: #f4f4f4;
        font-family: 'Poppins', 'Roboto', Arial, sans-serif;
    }
    
    .chat-container {
        width: 50%;
        margin: 30px auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        position: relative;
    }
    
    .date-time {
        font-size: 16px;
        font-weight: bold;
        color: #555;
        margin-bottom: 10px;
    }
    
    #chat-box {
        height: 300px;
        overflow-y: auto;
        border-radius: 5px;
        padding: 10px;
        border: none;
        background: #e9ecef;
        display: flex;
        flex-direction: column;
        scroll-behavior: smooth;
    }
    
    .message {
        padding: 10px 15px;
        margin: 8px 5px;
        border-radius: 12px;
        display: inline-block;
        max-width: 80%;
        word-wrap: break-word;
        position: relative;
        text-align: left;
    }
    
    .sent {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        align-self: flex-end;
        margin-left: auto;
    }
    
    .received {
        background: linear-gradient(135deg, #f0f0f0 0%, #d3d3d3 100%);
        align-self: flex-start;
        margin-right: auto;
    }
    
    .chat-input {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    #message-input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
    }
    
    #send-btn {
        padding: 10px 20px;
        border: none;
        background: linear-gradient(135deg, #85cce7 0%, #5aa6d6 100%);
        color: white;
        cursor: pointer;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    #send-btn:hover {
        background: linear-gradient(135deg, #5aa6d6 0%, #007bff 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
    }

    /* Delete Button */
    .delete-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        cursor: pointer;
        position: absolute;
        top: 5px;
        right: 5px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .delete-btn i {
        color: white;
        font-size: 11px;
    }

    .delete-btn:hover {
        background: rgba(255, 0, 0, 0.8);
    }

    .delete-btn:hover i {
        color: white;
    }

    .sent:hover .delete-btn {
        display: flex;
    }

    .date-divider {
        text-align: center;
        font-size: 12px;
        color: #666;
        margin: 15px 0;
        font-weight: bold;
        position: relative;
    }
    
    .date-divider:before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        height: 1px;
        background: #ddd;
        z-index: 1;
    }
    
    .date-divider span {
        background: #e9ecef;
        padding: 0 10px;
        position: relative;
        z-index: 2;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
        .chat-container {
            width: 95%;
            margin: 20px auto;
            padding: 15px;
        }
        
        #chat-box {
            height: 250px;
            padding: 8px;
        }
        
        .message {
            max-width: 90%;
            padding: 8px 12px;
            margin: 6px 5px;
            font-size: 14px;
        }
        
        .date-time {
            font-size: 14px;
        }
        
        h2 {
            font-size: 1.5rem;
        }
        
        .chat-input {
            flex-direction: column;
            gap: 8px;
        }
        
        #message-input {
            padding: 10px;
        }
        
        #send-btn {
            padding: 10px;
            width: 100%;
        }
        
        .delete-btn {
            width: 20px;
            height: 20px;
        }
        
        .delete-btn i {
            font-size: 10px;
        }
    }
    
    /* Tablet Styles */
    @media (min-width: 769px) and (max-width: 992px) {
        .chat-container {
            width: 70%;
        }
        
        #chat-box {
            height: 280px;
        }
    }
    
    /* Scrollbar Styling */
    #chat-box::-webkit-scrollbar {
        width: 6px;
    }
    
    #chat-box::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    #chat-box::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    #chat-box::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* Message Timestamp */
    .message small {
        display: block;
        font-size: 11px;
        margin-top: 3px;
        opacity: 0.8;
    }
    
    .sent small {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .received small {
        color: #666;
    }
</style>

<div class="chat-container">
    <div class="date-time" id="date-time"></div>
    <h2>Group Chat</h2>
    <div id="chat-box"></div>
    <div class="chat-input">
        <input type="text" id="message-input" placeholder="Type a message...">
        <button id="send-btn">Send</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function updateDateTime() {
        var now = new Date();
        var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        var formattedDate = now.toLocaleDateString('en-US', options);
        var formattedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById("date-time").innerText = formattedDate + " | " + formattedTime;
    }

    setInterval(updateDateTime, 1000);
    updateDateTime();

    function scrollToBottom() {
        let chatBox = $('#chat-box');
        chatBox.stop().animate({ scrollTop: chatBox[0].scrollHeight }, 300);
    }

    function loadMessages() {
        $.get('/get_messages/', function(data) {
            let chatBox = $('#chat-box');
            chatBox.html('');

            for (let date in data.grouped_messages) {
                chatBox.append(`<div class="date-divider"><span>${date}</span></div>`);

                data.grouped_messages[date].forEach(msg => {
                    let msgClass = msg.sender === '{{ request.user.username }}' ? 'sent' : 'received';
                    
                    // Format timestamp to show only time (HH:MM)
                    let messageTime = new Date(msg.timestamp).toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });

                    let deleteButton = msg.is_owner ? `
                        <button class="delete-btn" onclick="deleteMessage(${msg.id})" title="Delete message">
                            <i class="fas fa-trash-alt"></i>
                        </button>` : '';

                    let formattedMessage = `
                        <div class="message ${msgClass}">
                            <strong>${msg.sender}</strong><br>
                            ${msg.message}
                            <small>${messageTime}</small>
                            ${deleteButton}
                        </div>
                    `;
                    chatBox.append(formattedMessage);
                });
            }
            setTimeout(scrollToBottom, 100);
        });
    }

    function deleteMessage(messageId) {
        if(confirm('Are you sure you want to delete this message?')) {
            $.ajax({
                url: `/delete_message/${messageId}/`,
                type: 'POST',
                data: { 
                    'csrfmiddlewaretoken': '{{ csrf_token }}' 
                },
                success: function(response) {
                    if (response.status === 'success') {
                        loadMessages();
                    } else {
                        alert(response.message || 'Failed to delete message.');
                    }
                },
                error: function(xhr) {
                    alert('Failed to delete message. Please try again.');
                }
            });
        }
    }

    $(document).ready(function() {
        loadMessages();
        setInterval(loadMessages, 2000);

        $('#send-btn').click(function() {
            var message = $('#message-input').val().trim();
            if (message !== '') {
                $.post('/send_message/', { 
                    'message': message, 
                    'csrfmiddlewaretoken': '{{ csrf_token }}' 
                }, function(data) {
                    $('#message-input').val('');
                    loadMessages();
                }).fail(function() {
                    alert('Failed to send message. Please try again.');
                });
            }
        });

        $('#message-input').keypress(function(e) {
            if (e.which == 13 && !e.shiftKey) {
                e.preventDefault();
                $('#send-btn').click();
            }
        });

        // Focus on input when page loads
        $('#message-input').focus();
        
        // Auto-scroll to bottom
        setTimeout(scrollToBottom, 500);
    });
</script>

{% endblock content %}